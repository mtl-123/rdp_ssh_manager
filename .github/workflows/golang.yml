name: 构建Linux静态二进制（rdp_ssh_manager）

# 触发条件：推送到main/master分支、PR到main/master分支、手动触发
on:
  push:
    branches: [ main, master ]
    paths:
      - "main.go"
      - ".github/workflows/build.yml" # 仅当代码或工作流文件变更时触发
  pull_request:
    branches: [ main, master ]
    paths:
      - "main.go"
      - ".github/workflows/build.yml"
  workflow_dispatch: # 手动触发按钮

# 作业定义
jobs:
  build-linux-amd64:
    # 运行环境：最新版Ubuntu
    runs-on: ubuntu-latest
    timeout-minutes: 15 # 超时时间，避免无限运行

    steps:
      # 步骤1：检出代码到工作目录
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # 仅拉取最新提交，加速

      # 步骤2：设置Go环境（匹配项目依赖的版本）
      - name: 配置Go环境
        uses: actions/setup-go@v5
        with:
          go-version: '1.22' # 建议使用项目实际依赖的Go版本（1.19+均可）
          cache: true # 缓存Go模块，加速后续构建
          cache-dependency-path: go.sum # 依赖缓存依据

      # 步骤3：安装系统依赖（用于验证静态链接的file工具）
      - name: 安装系统依赖
        run: |
          sudo apt-get update -y
          sudo apt-get install -y file # 用于检测二进制文件链接类型
          sudo apt-get clean # 清理缓存，减少空间占用

      # 步骤4：初始化Go模块并整理依赖（核心修复模块匹配问题）
      - name: 初始化Go Module并整理依赖
        run: |
          # 初始化模块（替换为你的GitHub仓库地址，可自定义）
          if [ ! -f "go.mod" ]; then
            go mod init github.com/your-username/rdp_ssh_manager
          fi
          # 自动整理依赖（拉取缺失的、清理无用的）
          go mod tidy
          # 打印依赖信息，便于调试
          go list -m all

      # 步骤5：静态编译Go二进制文件（核心编译逻辑）
      - name: 编译静态二进制
        run: |
          cd ${{ env.WORK_DIR }}
          # 定义编译变量
          BIN_NAME="rdp_ssh_manager"
          BIN_PATH="../bin/${BIN_NAME}" # 输出到根目录的bin文件夹
          BUILD_VERSION="v1.0.0"
          BUILD_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")

          # 创建输出目录
          mkdir -p ../bin

          # ========== 关键修复：1. 补全ldflags格式 2. 兼容无变量的情况 ==========
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
          go build -ldflags " \
            -s -w \
            -extldflags '-static' \
            -X main.version=${BUILD_VERSION} \
            -X main.commit=${BUILD_COMMIT} \
            -X 'main.buildTime=${BUILD_TIME}' \
          " -trimpath -o "${BIN_PATH}" main.go

          # 验证编译结果
          ls -lh ../bin/
          file "${BIN_PATH}"
        shell: /usr/bin/bash -e {0}

      # 步骤6：验证二进制文件是否生成
      - name: 验证二进制文件存在性
        run: |
          BIN_NAME="rdp_ssh_manager"
          BIN_PATH="bin/${BIN_NAME}"
          if [ ! -f "$BIN_PATH" ]; then
            echo "FATAL: 二进制文件未生成！路径：${BIN_PATH}"
            exit 1
          fi
          echo "✅ 二进制文件生成成功：$(ls -lh ${BIN_PATH})"

      # 步骤7：验证静态链接（确保无动态依赖）
      - name: 验证静态链接特性
        run: |
          BIN_NAME="rdp_ssh_manager"
          BIN_PATH="bin/${BIN_NAME}"
          # 检测是否为静态链接
          if file "$BIN_PATH" | grep -qi "statically linked"; then
            echo "✅ 二进制文件为纯静态链接"
          else
            echo "WARNING: 二进制文件非纯静态链接，但仍尝试继续"
            # 打印详细文件信息，便于排查
            file "$BIN_PATH"
            ldd "$BIN_PATH" || true
          fi

      # 步骤8：上传编译产物（便于下载使用）
      - name: 上传编译产物到Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rdp_ssh_manager-linux-amd64-${{ github.sha }} # 产物名称包含提交哈希
          path: bin/rdp_ssh_manager # 要上传的文件路径
          retention-days: 30 # 产物保留30天，可按需调整
          if-no-files-found: error # 无文件时标记为失败

      # 可选步骤：发布Release（如需自动创建Release，取消注释以下配置）
      # - name: 创建GitHub Release
      #   if: github.event_name == 'push' && github.ref == 'refs/heads/main' # 仅主分支推送时触发
      #   uses: softprops/action-gh-release@v2
      #   with:
      #     tag_name: v1.0.0-${{ github.sha }}
      #     name: rdp_ssh_manager-v1.0.0-${{ github.sha }}
      #     files: bin/rdp_ssh_manager
      #     body: |
      #       自动构建的Linux AMD64静态二进制
      #       提交哈希：${{ github.sha }}
      #       构建时间：${{ github.run_at }}
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub自动生成的Token，无需手动配置
